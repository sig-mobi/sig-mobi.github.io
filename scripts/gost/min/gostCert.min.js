/*
 2014-2016, Rudolf Nickolaev. All rights reserved.
*/
(function(m,v){"function"===typeof define&&define.amd?define(["gostCrypto","gostASN1"],v):"object"===typeof exports?module.exports=v(require("gostCrypto"),require("gostASN1")):m.GostCert=v(m.gostCrypto,m.GostASN1)})(this,function(m){function v(a){for(var b=1,c=arguments.length;b<c;b++){var d=arguments[b];if("object"===typeof d)for(var e in d)d.hasOwnProperty(e)&&(a[e]=d[e])}return a}function t(a){var b=function(){};b.prototype=a.prototype;for(var b=[new b],c=1;c<arguments.length;c++)b.push(arguments[c]);
return v.apply(this,b)}function w(a){var b=new O;b.setHours(0,0,0,0);a&&b.setDate(b.getDate()+a);return b}function q(a){try{a()}catch(b){}}function P(){var a=new Uint8Array(4);m.getRandomValues(a);a[0]&=127;return Q.Int16.encode(a)}function B(a,b){for(var c in a)if(a[c]!==b[c])return!1;for(c in b)if(a[c]!==b[c])return!1;return!0}function x(a,b){var c=a.extensions&&a.extensions.subjectKeyIdentifier,d;if((d=a&&b&&(!b.issuer||B(a.issuer,b.issuer))&&(!b.serialNumber||G(a.serialNumber,b.serialNumber)))&&
!(d=!b.subjectKeyIdentifier))a:if(d=b.subjectKeyIdentifier,c=new Uint8Array(c),d=new Uint8Array(d),c.length!==d.length)d=!1;else{for(var e=0,f=c.length;e<f;e++)if(c[e]!==d[e]){d=!1;break a}d=!0}return d&&(!b.subject||B(a.subject,b.subject))&&(!b.date||a.notBefore.getTime()<=b.date.getTime()&&a.notAfter.getTime()>b.date.getTime())}function C(a,b,c){a={subject:a.issuer,date:c};if(b=b&&b.authorityKeyIdentifier)a.subjectKeyIdentifier=b.keyIdentifier,b.authorityCertIssuer&&b.authorityCertIssuer[0]&&b.authorityCertSerialNumber&&
(a.issuer=b.authorityCertIssuer[0],a.serialNumber=b.authorityCertSerialNumber);return a}function A(a,b){for(var c=[],d=0,e=a.length;d<e;d++)x(a[d],b)&&c.push(a[d]);return c}function H(a,b){return(!b.issuer||B(a.issuer,b.issuer))&&(!b.date||a.thisUpdate.getTime()<b.date.getTime())}function I(a,b){for(var c=[],d=0,e=a.length;d<e;d++)H(a[d],b)&&c.push(a[d]);return c}function E(a){a=a.id;for(var b in s){var c=s[b];if(c.publicKey.id===a)return c}}function J(a,b,c){for(var d in b){var e=a,f=d,g=b[d];"object"!==
typeof g&&(g={value:g});void 0!==c&&(g.enumerable=c);y.defineProperty(e,f,g)}}function t(a,b,c,d){"function"!==typeof b&&(d=c,c=b,b=function(){a.apply(this,arguments)});b.prototype=y.create(a.prototype,{constructor:{value:b},superclass:{value:a.prototype}});c&&J(b.prototype,c,!0);if(a!==y)for(var e in a)b[e]=a[e];b.super=a;d&&J(b,d,!0);return b}function r(){}function K(a){try{h.CertificationRequest.call(this,a,!0)}catch(b){a=a||{},h.CertificationRequest.call(this,{version:0,subject:a.subject||l.subject,
subjectPublicKeyInfo:a.subjectPublicKeyInfo||{algorithm:{id:"noSignature"},subjectPublicKey:new D(0)},attributes:a.attributes||{extensionRequest:{keyUsage:l.userKeyUsage,extKeyUsage:l.userExtKeyUsage}},signatureAlgorithm:{id:"noSignature"},signatureValue:new D(0)})}}function L(a,b){this.certificates=a||[];this.crls=b||[]}function M(a){this.certStore=a}function F(){}function N(a,b,c){this.trustedCACerts=a||[];this.requireCRL=b||!1;this.requireCA=c||!0}var n=this.Promise,y=this.Object,D=this.ArrayBuffer,
O=this.Date,k=m.subtle,Q=m.coding,h=m.asn1,s=m.security.providers,G=function(){var a=function(a){var b=typeof a;return"undefined"===b||""===a?"0":"number"===b||a instanceof Number?a.toString(16).toLowerCase():a.replace("0x","").toLowerCase()},b=function(a,b){return(Array(b+1).join("0")+a).slice(-b)};return function(c,d){c=a(c);d=a(d);var e=Math.max(c.length,d.length);return b(c,e)===b(d,e)}}(),l={providerName:"CP-01",subject:{countryName:"RU",commonName:"Anonymous"},caKeyUsage:"digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign".split(" "),
caExtKeyUsage:"serverAuth clientAuth codeSigning emailProtection ipsecEndSystem ipsecTunnel ipsecUser timeStamping OCSPSigning".split(" "),userKeyUsage:["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement"],userExtKeyUsage:["clientAuth","emailProtection"],days:7305};r.prototype.options=l;var u=function(a){try{h.Certificate.call(this,a,!0)}catch(b){try{a=new h.CertificationRequest(a,!0)}catch(c){}a=a||{};h.Certificate.call(this,{version:2,serialNumber:a.serialNumber||
P(),signature:a.signature||{id:"noSignature"},issuer:a.subject||l.subject,notBefore:a.notBefore||w(),notAfter:a.notAfter||w(a.days||l.days),subject:a.subject||l.subject,subjectPublicKeyInfo:a.subjectPublicKeyInfo||{algorithm:{id:"noSignature"},subjectPublicKey:new D(0)},extensions:a.attributes&&(a.attributes.extensionRequest||a.attributes.msCertExtensions)||a.extensions,signatureAlgorithm:{id:"noSignature"},signatureValue:new D(0)})}};t(h.Certificate,u,{sign:function(a,b){var c=this,d=c.subjectPublicKeyInfo;
return(new n(q)).then(function(){if(!d||!d.algorithm||"noSignature"===d.algorithm)throw Error("Key pair was not generated for the certificate");if(!a)throw Error("The private key of the issuer is not defined");b=b||c;return k.digest("SHA-1",d.subjectPublicKey)}).then(function(d){var f=b.getProvider()||s[l.providerName];c.signature&&"noSignature"!==c.signature.id||(c.signature=f.signature);c.signatureAlgorithm=c.signature;c.issuer=b.subject;c.extensions||(c.extensions={});var f=c.extensions,g=b.extensions;
if(c===b)f.keyUsage=f.keyUsage||l.caKeyUsage,f.extKeyUsage=f.extKeyUsage||l.caExtKeyUsage,f.basicConstraints=f.basicConstraints||{cA:!0};else{if(!b.checkUsage("keyCertSign",c.notBefore))throw Error("The issuer's certificate is not valid for signing a certificate");f.keyUsage=f.keyUsage||l.userKeyUsage;f.extKeyUsage=f.extKeyUsage||l.userExtKeyUsage;f.basicConstraints=f.basicConstraints||{cA:0<=f.keyUsage.indexOf("keyCertSign")};if(f.basicConstraints.cA){var h=g&&g.basicConstraints&&g.pathLenConstraint;
if(void 0!==h)if(0<h)f.basicConstraints.pathLenConstraint=h-1;else throw Error("Path length constraint exceeded");}}f.subjectKeyIdentifier=d;g&&g.subjectKeyIdentifier&&(f.authorityKeyIdentifier={keyIdentifier:g.subjectKeyIdentifier,authorityCertIssuer:[b.issuer],authorityCertSerialNumber:b.serialNumber});return k.importKey("pkcs8",a.encode(),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return k.sign(c.signatureAlgorithm,a,c.tbsCertificate.encode())}).then(function(a){c.signatureValue=a;return c})},
generate:function(a){var b=this,c,d;(d=a?s[a]:this.getProvider()||s[l.providerName])&&(a=v(d.publicKey,{privateKey:d.privateKey}));return(new n(q)).then(function(){return k.generateKey(a,"true",["sign","verify"])}).then(function(a){c=a.privateKey;return k.exportKey("spki",a.publicKey)}).then(function(a){b.subjectPublicKeyInfo=new h.SubjectPublicKeyInfo(a);return k.exportKey("pkcs8",c)}).then(function(a){return new h.PrivateKeyInfo(a)})},getPublicKey:function(){var a=this.subjectPublicKeyInfo,b="rsaEncryption"===
a.algorithm.id?["verify"]:["verify","deriveKey","deriveBits"];return k.importKey("spki",a.encode(),a.algorithm,"false",b)},getProvider:function(){return E(this.subjectPublicKeyInfo.algorithm)},verify:function(a,b,c){var d=this,e=d.extensions;return(new n(q)).then(function(){c=c||w();if(d.notBefore.getTime()>c.getTime()||d.notAfter.getTime()<=c.getTime())throw Error("The certificate has not yet started or expired");for(var b in e)if(e[b].critical&&0>"authorityKeyIdentifier subjectKeyIdentifier keyUsage certificatePolicies policyMappings basicConstraints nameConstraints policyConstraints extKeyUsage".split(" ").indexOf(b))throw Error("The critical extension '"+
b+"' is unrecognized");b=C(d,e,d.notBefore);!a&&x(d,b)&&(a=d);if(a){if(!x(a,b)||!a.checkUsage("keyCertSign",d.notBefore))throw Error("The issuer's certificate is not valid");return a.verifySignature(d.tbsCertificate.encode(),d.signatureValue,d.signatureAlgorithm)}return!0}).then(function(a){if(!a)throw Error("The certificate has invalid signature");if(b){if(!H(b,{issuer:d.issuer,date:c}))throw Error("The issuer's CRL is not valid");if(b.isRevoked(d.serialNumber))throw Error("The certificate is revoked");
}return d})},verifySignature:function(a,b,c){return this.getPublicKey().then(function(d){return k.verify(c,d,b,a)})},checkUsage:function(a,b){var c=this.extensions;b=b||w();return this.notBefore.getTime()<=b.getTime()&&this.notAfter.getTime()>b.getTime()&&(!c||!(0<["keyCertSign","cRLSign"].indexOf(a)&&c.basicConstraints&&!c.basicConstraints.cA||c.keyUsage&&0>c.keyUsage.indexOf(a)&&c.extKeyUsage&&0>c.extKeyUsage.indexOf(a)))}});r.prototype.X509=u;var z=function(a){z.super.call(this,a);this.version||
(this.version=1);this.revokedCertificates||(this.revokedCertificates=[]);this.thisUpdate||(this.thisUpdate=w())};t(h.CertificateList,z,{sign:function(a,b){var c=this;return(new n(q)).then(function(){if(!a)throw Error("The issuer's private key is not defined");if(!b)throw Error("The issuer's certificate is not defined");if(!c.issuer)c.issuer=b.issuer;else if(!B(c.issuer,b.issuer))throw Error("The CRL prototype and authority certificate have different issuers");if(!b.checkUsage("cRLSign",c.thisUpdate))throw Error("The issuer's certificate is not valid for signing a CRL");
var d=b.getProvider()||s[l.providerName];c.signature||(c.signature=d.signature);c.signatureAlgorithm=c.signature;c.issuer=b.subject;c.crlExtensions||(c.crlExtensions={});var d=c.crlExtensions,e=b.extensions;e&&e.subjectKeyIdentifier&&(d.authorityKeyIdentifier={keyIdentifier:e.subjectKeyIdentifier,authorityCertIssuer:[b.issuer],authorityCertSerialNumber:b.serialNumber});d.cRLNumber=d.cRLNumber||0;return k.importKey("pkcs8",a.encode(),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return k.sign(c.signatureAlgorithm,
a,c.tbsCertList.encode())}).then(function(a){c.signatureValue=a;return c})},verify:function(a,b){var c=this,d=c.crlExtensions;return(new n(q)).then(function(){b=b||w();if(!c.thisUpdate.getTime()>b.getTime())throw Error("The CRL has not yet started");if(a){if(!x(a,C(c,d,c.thisUpdate))||!a.checkUsage("cRLSign",c.thisUpdate))throw Error("The issuer's certificate is not valid");if(!c.signatureValue||!c.signatureAlgorithm)throw Error("The has no signature");return a.verifySignature(c.tbsCertList.encode(),
c.signatureValue,c.signatureAlgorithm)}}).then(function(a){if(!a)throw Error("The CRL has invalid signature");return c})},isRevoked:function(a,b){var c=this.revokedCertificates;b=b||w();for(var d=0;d<c.length;d++)if(b.getTime()>=c[d].revocationDate.getTime()&&G(c[d].userCertificate,a))return!0;return!1}});r.prototype.CRL=z;t(h.CertificationRequest,K,{generate:function(a){var b=this,c,d;(d=a?s[a]:this.getProvider()||s[l.providerName])&&(a=v(d.publicKey,{privateKey:d.privateKey}));return(new n(q)).then(function(){return k.generateKey(a,
"true",["sign","verify"])}).then(function(a){c=a.privateKey;return k.exportKey("spki",a.publicKey)}).then(function(a){b.subjectPublicKeyInfo=new h.SubjectPublicKeyInfo(a);return k.exportKey("pkcs8",c)}).then(function(a){c=new h.PrivateKeyInfo(a);return b.sign(c)}).then(function(){return c})},getProvider:function(){return E(this.subjectPublicKeyInfo.algorithm)},sign:function(a){var b=this,c=b.subjectPublicKeyInfo;return(new n(q)).then(function(){if(!c||!c.algorithm||"noSignature"===c.algorithm)throw Error("Key pair was not generated for the certificate");
if(!a)throw Error("The private key is not defined");var d=E(c.algorithm)||s[l.providerName];b.signatureAlgorithm=d.signature;return k.importKey("pkcs8",a.encode(),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return k.sign(b.signatureAlgorithm,a,b.requestInfo.encode())}).then(function(a){b.signatureValue=a;return b})},verify:function(){var a=this,b=a.subjectPublicKeyInfo;return(new n(q)).then(function(){return k.importKey("spki",b.encode(),b.algorithm,"false",["verify"])}).then(function(b){return k.verify(a.signatureAlgorithm,
b,a.signatureValue,a.requestInfo.encode())}).then(function(b){if(!b)throw Error("The certification request has invalid signature");return a})}});r.prototype.Request=K;t(y,L,{getCertificates:function(a){return A(this.certificates,a)},getCRLs:function(a){return I(this.certificates,a)},load:function(a){var b=new h.ContentInfo(a);a=b.certificates;for(var b=b.crls,c=0;c<a.length;c++)this.certificates.push(new u(a[c]));for(c=0;c<b.length;c++)this.crls.push(new z(b[c]));return this},store:function(){return new h.ContentInfo({contentType:"signedData",
version:0,digestAlgorithms:[],encapContentInfo:{contentType:"data"},certificates:this.certs,crls:this.crls,signerInfos:[]})}});r.prototype.CertStore=L;t(y,M,{build:function(a,b){var c=this;return(new n(q)).then(function(){for(var d=new u(a),e=[],f=!1,g=[];d;){var h=[],k=[];e.push(d);if(!f){var h=c.certStore.getCRLs({issuer:d.issuer,date:b}),l=C(d,d.extensions,d.notBefore);x(d,l)?f=!0:k=c.certStore.getCertificates(l)}k=0<k.length&&new u(k[0]);(h=0<h.length&&new z(h[0]))&&g.push(h.verify(k,b));g.push(d.verify(k,
h,b));d=k}if(!f)throw Error("Root certificate is not found");return n.all(g).then(function(a){for(var b=0;b<a;b++)if(!a[b])throw Error("Certification path is not validated");return e})})}});r.prototype.CertPath=M;t(y,F,{getValidCertificate:function(a,b,c){}});r.prototype.CertificateTrustPolicy=F;t(F,N,{getValidCertificate:function(a,b,c,d){var e=this,f;return(new n(q)).then(function(){b=b||[];c=c||[];var g=A(e.trustedCACerts,a);if(0<g.length)return new u(g[0]);g=A(b,a);if(0!==g.length){var g=new u(g[0]),
h=!1,k=[];for(f=[];g;){var l=[],p=[];f.push(g);if(!h){l=I(c,{issuer:g.issuer,date:d});if(0===l.length&&e.requireCRL)return;a=C(g,g.extensions,g.notBefore);p=A(e.trustedCACerts,a);if(0===p.length){if(!x(g,a))if(p=A(b,a),0<p.length){var m=p[0].extensions;if(e.requireCA&&(!m||!m.basicConstraints||!m.basicConstraints.cA||void 0!==m.basicConstraints.pathLenConstraint&&m.basicConstraints.pathLenConstraint<f.length-1))return}else return}else h=!0}p=0<p.length&&new u(p[0]);(l=0<l.length&&new z(l[0]))&&k.push(l.verify(p,
d));k.push(g.verify(p,l,d));g=p}if(!h)throw Error("Trusted root certificate is not found");return n.all(k).then(function(a){for(var b=0;b<a;b++)if(!a[b])throw Error("Certification path is not validated");return f[0]})}})}});r.prototype.TrustedCAPolicy=N;m.cert=new r;return r});
